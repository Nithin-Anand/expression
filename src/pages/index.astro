---
import BaseLayout from "../layouts/BaseLayout.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import { getAlbumImages, getPortfolioImages } from "../utils/albums";
import { CldImage } from "astro-cloudinary";
import { getCldImageUrl } from "astro-cloudinary/helpers";
import Lightbox from "../components/Lightbox.astro";

// Fetch the portfolio album

// Ensure the portfolio album exists

// Fetch images for the portfolio album
// const images = await getAlbumImages(portfolio.id);
// Fetch images for the portfolio album
const rawImages = await getPortfolioImages();

// Fetch latest blog post
const allPosts = await getCollection("blog");
const sortedPosts = allPosts
  .filter((post) => post.data.draft !== true)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const latestPost = sortedPosts.length > 0 ? sortedPosts[0] : null;

interface PortfolioImage {
  src: string;
  caption?: string;
  width: number;
  height: number;
  format: string;
}

const images = rawImages
  ? rawImages.map((image: PortfolioImage) => {
      const publicId = image.src;
      const lightboxAvif = getCldImageUrl({
        src: publicId,
        format: "avif",
        width: 1920,
        quality: "auto",
      });
      const lightboxWebp = getCldImageUrl({
        src: publicId,
        format: "webp",
        width: 1920,
        quality: "auto",
      });
      return {
        ...image,
        src: publicId,
        lightboxAvif: lightboxAvif,
        lightboxWebp: lightboxWebp,
      };
    })
  : [];
---

<BaseLayout
  pageTitle="Minimally Processed"
  hideTitle="true"
  class="text-center"
>
  <!-- Hero Section -->
  <section class="py-20 px-4 text-center">
    <h1
      class="text-5xl md:text-7xl font-bold text-neutral-900 mb-6 tracking-tight"
    >
      Minimally Processed
    </h1>
    <p
      class="text-xl md:text-2xl text-neutral-600 max-w-2xl mx-auto font-light leading-relaxed"
    >
      Life through my lens.
    </p>
  </section>
  {
    latestPost && (
      <div class="hidden md:block mx-auto container px-4 sm:px-8 mb-16">
        <a
          href={`/blog/${latestPost.id}`}
          class="block group relative overflow-hidden rounded-2xl shadow-sm hover:shadow-xl transition-all duration-500 max-w-5xl mx-auto"
        >
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent z-10 opacity-90 group-hover:opacity-100 transition-opacity" />
          {latestPost.data.cover && (
            <Image
              src={latestPost.data.cover}
              alt={latestPost.data.title}
              width={1200}
              height={600}
              class="w-full h-[400px] object-cover transform group-hover:scale-105 transition-transform duration-700"
            />
          )}
          <div class="absolute bottom-0 left-0 p-8 z-20 text-left w-full">
            <span class="inline-block px-3 py-1 bg-white/20 backdrop-blur-sm text-white text-xs font-medium uppercase tracking-wider rounded-full mb-4 border border-white/30">
              Latest Story
            </span>
            <h3 class="text-3xl md:text-4xl font-bold text-white mb-2 font-serif group-hover:text-neutral-100 transition-colors">
              {latestPost.data.title}
            </h3>
            <p class="text-neutral-200 text-lg line-clamp-2 max-w-2xl font-light">
              {latestPost.data.description}
            </p>
          </div>
        </a>
      </div>
    )
  }

  <div class="text-center">
    <div
      class="mx-auto container py-8 px-4 sm:px-8 sm:columns-2 lg:columns-3 text-center gap-4"
    >
      {
        images &&
          images.map((image: any) => (
            <CldImage
              src={image.src}
              alt={image.caption || `Image from portfolio album`}
              width={600}
              width={600}
              class="rounded-lg mb-4 hover:shadow-2xl transition-all duration-500 ease-out hover:-translate-y-1 cursor-zoom-in"
              loading="lazy"
              data-lightbox
              data-lightbox-avif={image.lightboxAvif}
              data-lightbox-webp={image.lightboxWebp}
            />
          ))
      }
    </div>
  </div>
  <div>
    <Lightbox />
  </div>
</BaseLayout>
